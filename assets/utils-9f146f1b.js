function x(r,e=[]){do{const t=r&127;r>>>=7,e.push(t|(r===0?0:128))}while(r>0);return e}function y(r,e=0){let t=e,n=(r[e]&127)<<0;return 128&r[e++]&&(n|=(r[e]&127)<<7,128&r[e++]&&(n|=(r[e]&127)<<14,128&r[e++]&&(n|=(r[e]&127)<<21))),[n,e,t]}const w=A();function A(){let r=new Map,e=[[1,"u8","payload_format_indicator"],[2,"u32","message_expiry_interval"],[3,"utf8","content_type"],[8,"utf8","response_topic"],[9,"bin","correlation_data"],[11,"vint","subscription_identifier"],[17,"u32","session_expiry_interval"],[18,"utf8","assigned_client_identifier"],[19,"u16","server_keep_alive"],[21,"utf8","authentication_method"],[22,"bin","authentication_data"],[23,"u8","request_problem_information"],[24,"u32","will_delay_interval"],[25,"u8","request_response_information"],[26,"utf8","response_information"],[28,"utf8","server_reference"],[31,"utf8","reason_string"],[33,"u16","receive_maximum"],[34,"u16","topic_alias_maximum"],[35,"u16","topic_alias"],[36,"u8","maximum_qos"],[37,"u8","retain_available"],[38,"pair","user_properties",{op:"kv_obj"}],[39,"u32","maximum_packet_size"],[40,"u8","wildcard_subscription_available"],[41,"u8","subscription_identifiers_available",{op:"u8_vec"}],[42,"u8","shared_subscription_available"]];for(let[t,n,i,s]of e){let o={id:t,type:n,name:i,...s};r.set(o.id,o),r.set(o.name,o)}return r}class T extends Number{static of(e,t,n){let i=new this(e);return i.reason=n?.[t]?.get(e)||t,i}}class ${static of(e){return this.prototype.of(e)}of(e){let t=(n,i)=>(i=0|t.k,t.k=i+n,i);return{__proto__:this,buf:e,step:t}}has_more(){return this.buf.byteLength>(this.step.k|0)}u8(){return this.buf[this.step(1)]}u16(){let{buf:e,step:t}=this,n=t(2);return e[n]<<8|e[n+1]}u32(){let{buf:e,step:t}=this,n=t(4);return e[n]<<24|e[n+1]<<16|e[n+2]<<8|e[n+3]}vint(){let{buf:e,step:t}=this,[n,i,s]=y(e,t.k|0);return t(i-s),n}bin(){let{buf:e,step:t}=this,n=t(2),i=e[n]<<8|e[n+1];return n=t(i),e.subarray(n,n+i)}utf8(){return new TextDecoder("utf-8").decode(this.bin())}pair(){return[this.utf8(),this.utf8()]}flags(e){return new e(this.buf[this.step(1)])}reason(e){let t=this.buf[this.step(1)];if(t!=null)return T.of(t,e,this._reasons_by)}flush(){let{buf:e,step:t}=this;return this.step=this.buf=null,e.subarray(t.k|0)}}class j extends ${props(){let{buf:e,step:t}=this,[n,i,s]=y(e,t.k|0);if(t(n+i-s),n===0)return null;let o={},a=this.of(e.subarray(i,t.k|0));for(;a.has_more();){let u=w.get(a.u8()),c=a[u.type]();o[u.name]=u.op?a[u.op](o[u.name],c):c}return o}kv_obj(e=Object.create(null),[t,n]){return e[t]=n,e}u8_vec(e=[],t){return e.push(t),e}}function U(r,...e){r=class extends r{static reasons(t,...n){let i=this.prototype;i._reasons_by={...i._reasons_by};let s=i._reasons_by[t]||=new Map;for(let[o,a]of n)s.set(o,a);return this}};for(let t of e)t(r);return r}class M{static of(){return this.prototype.of()}of(){return{__proto__:this,$:[]}}static init(){return this}as_pkt(e){return this.pack([e])}push(...e){this.$.push(...e)}pack(e){let t,n,i=0,s=this.$;this.$=!1;for(t of s)i+=t.length;e=x(i,e),n=e.length;let o=new Uint8Array(n+i);o.set(e,0);for(t of s)o.set(t,n),n+=t.length;return o}u8(e){this.push([e&255])}u16(e){this.push([e>>>8&255,e&255])}u32(e){this.push([e>>>24&255,e>>>16&255,e>>>8&255,e&255])}vint(e){this.push(x(e))}bin(e){if(!e)return this.u16(0);if(typeof e=="string")return this.utf8(e);e.length!==e.byteLength&&(e=new Uint8Array(e)),this.u16(e.byteLength),this.push(e)}utf8(e){let t=new TextEncoder("utf-8").encode(e);this.u16(t.byteLength),this.push(t)}pair(e,t){this.utf8(e),this.utf8(t)}flags(e,t,n=0){return e!==void 0&&isNaN(+e)&&(e=t(e,0)),e|=n,this.push([e]),e}reason(e){this.push([e|0])}flush(e){e!=null&&this.push(typeof e=="string"?new TextEncoder("utf-8").encode(e):e),this.push=!1}}class P extends M{props(e){if(!e)return this.u8(0);if(Array.isArray(e)||(e=e.entries?Array.from(e.entries()):Object.entries(e)),e.length===0)return this.u8(0);let t=this.of();for(let[n,i]of e){let s=w.get(n);t[s.op||"one"](i,s)}this.push(t.pack())}one(e,t){this.u8(t.id),this[t.type](e)}kv_obj(e,t){for(let n of Object.entries(e))this.u8(t.id),this.pair(n)}u8_vec(e,t){for(let n of e)this.u8(t.id),this.u8(n)}}function N(r,e){class t extends Number{get session_present(){return this&!0}}return r[2]=(n,i)=>{let s=e.of(i);return n.flags=s.flags(t),n.reason=s.reason(n.type),5<=n.mqtt_level&&(n.props=s.props()),n}}function C(r){r.reasons("connack",[0,"Success"],[1,"Connection refused, unacceptable protocol version"],[2,"Connection refused, identifier rejected"],[3,"Connection refused, server unavailable"],[4,"Connection refused, bad user name or password"],[5,"Connection refused, not authorized"])}function E(r){C(r),r.reasons("connack",[129,"Malformed Packet"],[130,"Protocol Error"],[131,"Implementation specific error"],[132,"Unsupported Protocol Version"],[133,"Client Identifier not valid"],[134,"Bad User Name or Password"],[135,"Not authorized"],[136,"Server unavailable"],[137,"Server busy"],[138,"Banned"],[140,"Bad authentication method"],[144,"Topic Name invalid"],[149,"Packet too large"],[151,"Quota exceeded"],[153,"Payload format invalid"],[154,"Retain not supported"],[155,"QoS not supported"],[156,"Use another server"],[157,"Server moved"],[159,"Connection rate exceeded"])}function I(r,e){return r[3]=(t,n)=>{let{hdr:i}=t;t.dup=Boolean(i&8),t.retain=Boolean(i&1);let s=t.qos=i>>1&3,o=e.of(n);return t.topic=o.utf8(),s!==0&&(t.pkt_id=o.u16()),5<=t.mqtt_level&&(t.props=o.props()),t.payload=o.flush(),t}}function Q(r,e){return r[4]=(t,n)=>{let i=e.of(n);return t.pkt_id=i.u16(),5<=t.mqtt_level&&(t.reason=i.reason(t.type),t.props=i.props()),t}}function B(r){r.reasons("puback",[0,"Success"],[16,"No matching subscribers"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[144,"Topic Name invalid"],[145,"Packet identifier in use"],[151,"Quota exceeded"],[153,"Payload format invalid"])}function q(r){return(e,t)=>{let n=r.of(t);e.pkt_id=n.u16(),5<=e.mqtt_level&&(e.props=n.props());let i=e.answers=[];for(;n.has_more();)i.push(n.reason(e.type));return e}}function F(r,e){return r[9]=q(e)}function L(r){r.reasons("suback",[0,"Granted QoS 0"],[1,"Granted QoS 1"],[2,"Granted QoS 2"])}function O(r){L(r),r.reasons("suback",[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[143,"Topic Filter invalid"],[145,"Packet Identifier in use"],[151,"Quota exceeded"],[158,"Shared Subscriptions not supported"],[161,"Subscription Identifiers not supported"],[162,"Wildcard Subscriptions not supported"])}function D(r,e){return r[11]=q(e)}function R(r){r.reasons("unsuback",[0,"Success"],[17,"No subscription existed"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[143,"Topic Filter invalid"],[145,"Packet Identifier in use"])}function z(r){return r[12]=r[13]=e=>e}function W(r,e){return r[14]=(t,n)=>{if(n&&5<=t.mqtt_level){let i=e.of(n);t.reason=i.reason(t.type),t.props=i.props()}return t}}function G(r){r.reasons("disconnect",[0,"Normal disconnection"],[4,"Disconnect with Will Message"],[128,"Unspecified error"],[129,"Malformed Packet"],[130,"Protocol Error"],[131,"Implementation specific error"],[135,"Not authorized"],[137,"Server busy"],[139,"Server shutting down"],[141,"Keep Alive timeout"],[142,"Session taken over"],[143,"Topic Filter invalid"],[144,"Topic Name invalid"],[147,"Receive Maximum exceeded"],[148,"Topic Alias invalid"],[149,"Packet too large"],[150,"Message rate too high"],[151,"Quota exceeded"],[152,"Administrative action"],[153,"Payload format invalid"],[154,"Retain not supported"],[155,"QoS not supported"],[156,"Use another server"],[157,"Server moved"],[158,"Shared Subscriptions not supported"],[159,"Connection rate exceeded"],[160,"Maximum connect time"],[161,"Subscription Identifiers not supported"],[162,"Wildcard Subscriptions not supported"])}function H(r,e){return r[15]=(t,n)=>{if(5<=t.mqtt_level){let i=e.of(n);t.reason=i.reason(t.type),t.props=i.props()}return t}}function J(r){r.reasons("auth",[0,"Success"],[24,"Continue authentication"],[25,"Re-authenticate"])}function K(r,e){const t=new Uint8Array([0,4,77,81,84,84]),n=s=>0|(s.reserved?1:0)|(s.will_qos&3)<<3|(s.clean_start?2:0)|(s.will_flag?4:0)|(s.will_retain?32:0)|(s.password?64:0)|(s.username?128:0),i=s=>4|(s.qos&3)<<3|(s.retain?32:0);return r.connect=(s,o)=>{let a=e.of(o);a.push(t),a.u8(s);let{will:u,username:c,password:_}=o,f=a.flags(o.flags,n,0|(c?128:0)|(_?64:0)|(u?i(u):0));return a.u16(o.keep_alive),5<=s&&a.props(o.props),a.utf8(o.client_id),f&4&&(5<=s&&a.props(u.props),a.utf8(u.topic),a.bin(u.payload)),f&128&&a.utf8(c),f&64&&a.bin(_),a.as_pkt(16)}}function V(r,e){return r.publish=(t,n)=>{let i=(n.qos&3)<<1,s=e.of(n);return s.utf8(n.topic),i!==0&&s.u16(n.pkt_id),5<=t&&s.props(n.props),s.flush(n.payload),s.as_pkt(48|i|(n.dup?8:0)|(n.retain?1:0))}}function X(r,e){return r.puback=(t,n)=>{let i=e.of(n);return i.u16(n.pkt_id),5<=t&&(i.reason(n.reason),i.props(n.props)),i.as_pkt(64)}}function Y(r,e){const t=n=>0|n.qos&3|(n.retain?4:0)|(n.retain_handling&3)<<2;return r.subscribe=(n,i)=>{let s=e.of(i);s.u16(i.pkt_id),5<=n&&s.props(i.props);let o=t(i);for(let a of i.topics)if(typeof a=="string")s.utf8(a),s.u8(o);else{let[u,c]=Array.isArray(a)?a:[a.topic,a.opts];s.utf8(u),c===void 0?s.u8(o):s.flags(c,t)}return s.as_pkt(130)}}function Z(r,e){return r.unsubscribe=(t,n)=>{let i=e.of(n);i.u16(n.pkt_id),5<=t&&i.props(n.props);for(let s of n.topics)i.utf8(s);return i.as_pkt(162)}}function k(r){r.pingreq=()=>new Uint8Array([192,0]),r.pingresp=()=>new Uint8Array([208,0])}function ee(r,e){return r.disconnect=(t,n)=>{let i=e.of(n);return n&&5<=t&&(n.reason||n.props)&&(i.reason(n.reason),i.props(n.props)),i.as_pkt(224)}}function te(r,e){return r.auth=(t,n)=>{if(5>t)throw new Error("Auth packets are only available after MQTT 5.x");let i=e.of(n);return i.reason(n.reason),i.props(n.props),i.as_pkt(240)}}const ne=[N,I,Q,F,D,z,W,H],re=[K,X,V,Y,Z,k,ee,te],ie=U(j,E,B,O,R,G,J),se={decode_fns:ne,mqtt_reader:ie,encode_fns:re,mqtt_writer:P};function oe(r,e=0){let t=e,n=(r[e]&127)<<0;return 128&r[e++]&&(n|=(r[e]&127)<<7,128&r[e++]&&(n|=(r[e]&127)<<14,128&r[e++]&&(n|=(r[e]&127)<<21))),[n,e,t]}function ae(r){let e=new Uint8Array(0);return t=>{e=e.byteLength===0?t:ue(e,t);let n=[];for(;;){let[i,s]=oe(e,1),o=i+s;if(e.byteLength<o)return n;let a=e[0],u=i===0?null:e.subarray(s,o);e=e.subarray(o);let c=r.decode_pkt(a,u,r);c!=null&&n.push(c)}}}function ue(r,e){let t=r.byteLength,n=new Uint8Array(t+e.byteLength);return n.set(r,0),n.set(e,t),n}const ce=["~","connect","connack","publish","puback","pubrec","pubrel","pubcomp","subscribe","suback","unsubscribe","unsuback","pingreq","pingresp","disconnect","auth"];function le(r,e,t){t={__proto__:t||e.pkt_ctx,mqtt_level:r,get hdr(){return this.b0&15},get id(){return this.b0>>>4},get type(){return ce[this.b0>>>4]}};let n,i=[],s={};for(n of e.encode_fns)n(s,e.mqtt_writer);for(n of e.decode_fns)n(i,e.mqtt_reader);return{pkt_ctx:t,encode_pkt(o,a){return s[o](r,a)},decode_pkt(o,a){return(i[o>>>4]||i[0])?.({__proto__:this.pkt_ctx,b0:o},a)},mqtt_stream(){let o={__proto__:this,pkt_ctx:{__proto__:t}};return o.pkt_ctx._base_=o.pkt_ctx,o.decode=ae(o),o}}}function _e(r=(...e)=>e){let e,t,n=(i,s)=>{e=i,t=s};return i=>(i=new Promise(n),r(i,e,t))}const d=_e();Promise.resolve({type:"init"});function fe(r,[e,t]){let n=d(),i=d(),s=async(...u)=>(await i[0])(...u),o,a;return r._send=s,{async when_ready(){await i[0]},ping:de(()=>o?.("pingreq")),reset(u){o&&(u&&n[2](u),o=null,n=d(),r._send=s,r.conn_emit("on_disconnect",u===!1,u))},async send_connect(...u){o||await n[0];let c=await o(...u);return c[0].reason==0&&(a=!0,i[1](r._send=o),i=d(),r.conn_emit("on_ready")),c},is_set:()=>!!o,set(u,c){if(o)throw new Error("Already connected");u=u.mqtt_stream();let _={mqtt:r},f=h=>e(u.decode(h),_);return o=async(h,g,p)=>{let S=p!==void 0?t(p):!0;return await c(u.encode_pkt(h,g)),S},n[1](o),r.conn_emit("on_live",a),f}}}function de(r){let e;return t=>{if(e=clearInterval(e),t)return e=setInterval(r,1e3*t),e.unref?.(),!0}}function he(r,e){if(r instanceof RegExp)return{keys:!1,pattern:r};var t,n,i,s,o=[],a="",u=r.split("/");for(u[0]||u.shift();i=u.shift();)t=i[0],t==="*"?(o.push("wild"),a+="/(.*)"):t===":"?(n=i.indexOf("?",1),s=i.indexOf(".",1),o.push(i.substring(1,~n?n:~s?s:i.length)),a+=~n&&!~s?"(?:/([^/]+?))?":"/([^/]+?)",~s&&(a+=(~n?"?":"")+"\\"+i.substring(s))):a+="/"+i;return{keys:o,pattern:new RegExp("^"+a+(e?"(?=$|/)":"/?$"),"i")}}function pe(r,e,t){t.done=!0}function xe(){let r=[[],[]],e=Symbol(),t=n=>me(r,n);return{find:t,add(n,...i){let s=i.pop(),o=i.pop();if(typeof s!="function")if(s===!1)s=pe;else throw new TypeError;let a=he(n.replace(/[+#]$/,"*"));return a.key=n,a.tgt=s,r[o?0:1].push(a),this},remove(n,i){let s=r[i?0:1];return m([s],n)},clear(n){r[n?0:1]=[],n==null&&(r[1]=[])},async invoke(n,i){i.idx=0,i.rm=e;for(let[a,u]of t(n.topic)){let c=await a(n,u,i);if(e===c&&m(r,a),i.done)break;i.idx++}let{pkt_id:s,qos:o}=n;o===1&&await i.mqtt._send("puback",{pkt_id:s})}}}function*me(r,e){for(let t of r)for(let n of t){let i=be(e,n);i!==void 0&&(yield i)}}function be(r,{keys:e,pattern:t,tgt:n}){let i=r[0]!=="/"?t.exec("/"+r):t.exec(r);if(i===null)return;if(e===!1){let{groups:o}=i;if(!o)return[n];let a={};for(let u in o)a[u]=o[u];return[n,a]}if(e.length===0)return[n];let s={};for(let o=0;o<e.length;o++)s[e[o]]=i[1+o];return[n,s]}function m(r,e){let t=n=>n===e||n.tgt===e||n.key===e;for(let n of r){let i=n.findIndex(t);if(0<=i)return!!n.splice(i,1)}return!1}const ye={create(r){return{__proto__:this,target:r,hashbelt:[new Map]}},bind_pkt_future(r=100){let{hashbelt:e}=this,t,n=i=>e[0].set(t,i);return i=>(typeof i=="string"?t=i:(r=r+1&65535,t=i.pkt_id=r),new Promise(n))},answer(r,e){for(let t of this.hashbelt){let n=t.get(r);if(n!==void 0)return t.delete(r),n([e]),!0}return!1},rotate_belt(r){let{hashbelt:e}=this;e.unshift(new Map);for(let t of e.splice(r||5))for(let n of t.values())n([,"expired"])},cmdids:(()=>{return[()=>{},t,e,t,r,r,r,r,t,r,t,r,e,e,t,e];function r(n,i){n.answer(i.pkt_id,i)}function e(n,i,s){n.answer(i.type,i),t(n,i,s)}async function t({target:n},i,s){let o=n[`mqtt_${i.type}`]||n.mqtt_pkt;o!==void 0&&await o.call(n,i,s)}})()};function we(r,e){let t=ye.create(e),{cmdids:n}=t,{td:i=1e3,n:s=5}=r&&r.rotate||{},o=i+Date.now();return[a,t.bind_pkt_future()];function a(u,c){for(let _ of u)n[_.id](t,_,c);Date.now()>o&&(t.rotate_belt(s),o=i+Date.now())}}class qe extends Error{constructor(e,t=e.reason){super(`[0x${t.toString(16)}] ${t.reason}`),this.mqtt_pkt=e,this.reason=t}}class v{constructor(e={}){this._conn_=fe(this,this._init_dispatch(e,this))}async conn_emit(e,t,n){this.log_conn?.(e,t,n);try{let i=this[await e];i?await i.call(this,this,t,n):n&&await this.on_error(n,e)}catch(i){this.on_error(i,e)}}on_error(e,t){console.warn("[[u8-mqtt error: %s]]",t,e)}async connect(e={}){let t=e.client_id||["u8-mqtt--",""];Array.isArray(t)&&(e.client_id=t=this.init_client_id(t)),this.client_id=t,e.keep_alive==null&&(e.keep_alive=60);let n=await this._conn_.send_connect("connect",e,"connack");if(n[0].reason!=0)throw new this.MQTTError(n[0]);return this._conn_.ping(e.keep_alive),n}async disconnect(e={}){let t=await this._send("disconnect",e);return this._conn_.reset(!1),t}auth(e={}){return this._send("auth",e,"auth")}ping(){return this._send("pingreq",null,"pingresp")}subscribe(e,t){return e=b(e,t),this._send("subscribe",e,e)}_sub_chain(e,t){let n=this.subscribe([[e]],t),i=this.subs||(this.subs=new Map);return i.set(n.topic=e,i.last=n),this}unsubscribe(e,t){return e=b(e,t),this._send("unsubscribe",e,e)}get on_topic(){return this.router.add}subscribe_topic(e,...t){this.router.add(e,!0,t.pop());let n=this.topic_for(e);return this._sub_chain(n,t.pop())}unsubscribe_topic(e){this.router.remove(e,!0);let t=this.topic_for(e);return this.unsubscribe([[t]])}shared_subscribe(e,t,...n){this.router.add(t,!0,n.pop());let i=this.topic_for(t);return e!=null&&(i=`$share/${e}/${i}`),this._sub_chain(i,n.pop())}shared_unsubscribe(e,t){this.router.remove(t,!0);let n=this.topic_for(t);return e!=null&&(n=`$share/${e}/${n}`),this.unsubscribe([[n]])}topic_for(e){return e.replace(/[:*].*$/,"#")}publish(e,t){return l(this,e,t)}post(e,t,n){return l.m(this,e,t,n)}send(e,t,n){return l.mq(this,e,t,n)}store(e,t,n){return l.mqr(this,e,t,n)}json_post(e,t,n){return l.o(this,e,t,n)}json_send(e,t,n){return l.oq(this,e,t,n)}json_store(e,t,n){return l.oqr(this,e,t,n)}obj_post(e,t,n){return l.o(this,e,t,n)}obj_send(e,t,n){return l.oq(this,e,t,n)}obj_store(e,t,n){return l.oqr(this,e,t,n)}init_client_id(e){let t=this.client_id;return t===void 0&&(this.client_id=t=this.sess_client_id(e)),t}new_client_id(e){return[e[0],Math.random().toString(36).slice(2),e[1]].join("")}sess_client_id(e){let t=e.join(" "),n=sessionStorage.getItem(t);return n==null&&(n=this.new_client_id(e),sessionStorage.setItem(t,n)),n}_init_router(e){return this.router=xe()}_init_dispatch(e){let t={__proto__:e.on_mqtt_type||{},router:this._init_router(e,this)};return t.mqtt_publish||=t.router.invoke,we(this,t)}}{let r=v.prototype;Object.assign(r,{MQTTError:qe,pub:r.publish,sub:r.subscribe,unsub:r.unsubscribe,sub_topic:r.subscribe_topic,unsub_topic:r.unsubscribe_topic,shared_sub:r.shared_subscribe,shared_unsub:r.shared_unsubscribe})}function b(r,e){return typeof r=="string"?{topics:[r],...e}:r[Symbol.iterator]?{topics:[...r],...e}:e?{...r,...e}:r}async function l(r,e,t){if(e.payload===void 0){typeof t=="function"&&(t={fn_encode:t});let{msg:n}=e;switch(typeof n){case"function":t={...t,fn_encode:n};case"undefined":return s=>l(r,{...e,[e.arg||"payload"]:s},t);default:let{fn_encode:i}=t||{};e.payload=i?await i(n):JSON.stringify(n)}}return t&&(t.props&&(e.props=t.props),t.xform&&(e=t.xform(e)||e)),r._send("publish",e,e.qos?e:void 0)}Object.assign(l,{m:(r,e,t,n)=>l(r,{topic:e,payload:t,qos:0},n),mq:(r,e,t,n)=>l(r,{topic:e,payload:t,qos:1},n),mqr:(r,e,t,n)=>l(r,{topic:e,payload:t,qos:1,retain:1},n),o:(r,e,t,n)=>l(r,{topic:e,msg:t,arg:"msg",qos:0},n),oq:(r,e,t,n)=>l(r,{topic:e,msg:t,arg:"msg",qos:1},n),oqr:(r,e,t,n)=>l(r,{topic:e,msg:t,arg:"msg",qos:1,retain:1},n)});const ve={utf8(r){return new TextDecoder("utf-8").decode(r||this.payload)},json(r){return JSON.parse(this.utf8(r)||null)},text(r){return this.utf8(r)}};class ge extends v{constructor(e={}){super(e),this.with(e)}static mqtt_ctx(e,t,n=ve){let i=class extends this{};return i.prototype.mqtt_ctx=le(e,t,n),i}with(e){for(let[t,n]of Object.entries(e))typeof n=="function"&&(this[t]=n);return this}on_live(e,t){if(t)return e.connect()}_use_conn(e){return(this.reconnect=e)?.()}with_autoreconnect(e=2e3){return e.toFixed&&(e={delay:e}),this.with({on_reconnect(){this.delay(e.delay||2e3).then(this.reconnect).then(e.reconnect,e.error)}})}on_disconnect(e,t){if(!t)return e.on_reconnect?.()}delay(e){return new Promise(t=>setTimeout(t,e))}with_async_iter(e,t){let n=this._conn_.set(this.mqtt_ctx,t);return this._msg_loop=(async()=>{try{e=await e;for await(let i of e)n(i);this._conn_.reset()}catch(i){this._conn_.reset(i)}})(),this}with_stream(e,t){return t===void 0&&(t=e),this.with_async_iter(e,n=>t.write(n))}with_websock(e){if(!e?.send)return e=new URL(e||"ws://127.0.0.1:9001"),this._use_conn(()=>this.with_websock(new WebSocket(e,["mqtt"])));e.binaryType="arraybuffer";let t,{readyState:n}=e;if(n!==1){if(n!==0)throw new Error("Invalid WebSocket readyState");t=new Promise(o=>e.onopen=o)}let{_conn_:i}=this,s=i.set(this.mqtt_ctx,async o=>(await t,e.send(o)));return e.onmessage=o=>s(new Uint8Array(o.data)),e.onclose=o=>{if(!o.wasClean){var a=new Error("websocket connection close");a.code=o.code,a.reason=o.reason}i.reset(a)},this}}const Se=ge.mqtt_ctx(4,se),Ae=r=>new Se(r);async function Te(){console.log("Connecting to MQTT host: wss://test.mosquitto.org:8081/mqtt");let r=Ae().with_websock("wss://test.mosquitto.org:8081/mqtt").with_autoreconnect();return await r.connect(),r}function $e(r){return`${r}/commands`}function je(r){const e=window.location;let t=`${e.origin}${e.pathname}#/handheld?id=${r}`;return console.log("Handheld URL: "+t),t}export{$e as a,je as b,Te as g};
