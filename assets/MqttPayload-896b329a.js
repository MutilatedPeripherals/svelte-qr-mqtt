function x(r,e=[]){do{const t=r&127;r>>>=7,e.push(t|(r===0?0:128))}while(r>0);return e}function y(r,e=0){let t=e,n=(r[e]&127)<<0;return 128&r[e++]&&(n|=(r[e]&127)<<7,128&r[e++]&&(n|=(r[e]&127)<<14,128&r[e++]&&(n|=(r[e]&127)<<21))),[n,e,t]}const w=T();function T(){let r=new Map,e=[[1,"u8","payload_format_indicator"],[2,"u32","message_expiry_interval"],[3,"utf8","content_type"],[8,"utf8","response_topic"],[9,"bin","correlation_data"],[11,"vint","subscription_identifier"],[17,"u32","session_expiry_interval"],[18,"utf8","assigned_client_identifier"],[19,"u16","server_keep_alive"],[21,"utf8","authentication_method"],[22,"bin","authentication_data"],[23,"u8","request_problem_information"],[24,"u32","will_delay_interval"],[25,"u8","request_response_information"],[26,"utf8","response_information"],[28,"utf8","server_reference"],[31,"utf8","reason_string"],[33,"u16","receive_maximum"],[34,"u16","topic_alias_maximum"],[35,"u16","topic_alias"],[36,"u8","maximum_qos"],[37,"u8","retain_available"],[38,"pair","user_properties",{op:"kv_obj"}],[39,"u32","maximum_packet_size"],[40,"u8","wildcard_subscription_available"],[41,"u8","subscription_identifiers_available",{op:"u8_vec"}],[42,"u8","shared_subscription_available"]];for(let[t,n,s,i]of e){let o={id:t,type:n,name:s,...i};r.set(o.id,o),r.set(o.name,o)}return r}class E extends Number{static of(e,t,n){let s=new this(e);return s.reason=n?.[t]?.get(e)||t,s}}class ${static of(e){return this.prototype.of(e)}of(e){let t=(n,s)=>(s=0|t.k,t.k=s+n,s);return{__proto__:this,buf:e,step:t}}has_more(){return this.buf.byteLength>(this.step.k|0)}u8(){return this.buf[this.step(1)]}u16(){let{buf:e,step:t}=this,n=t(2);return e[n]<<8|e[n+1]}u32(){let{buf:e,step:t}=this,n=t(4);return e[n]<<24|e[n+1]<<16|e[n+2]<<8|e[n+3]}vint(){let{buf:e,step:t}=this,[n,s,i]=y(e,t.k|0);return t(s-i),n}bin(){let{buf:e,step:t}=this,n=t(2),s=e[n]<<8|e[n+1];return n=t(s),e.subarray(n,n+s)}utf8(){return new TextDecoder("utf-8").decode(this.bin())}pair(){return[this.utf8(),this.utf8()]}flags(e){return new e(this.buf[this.step(1)])}reason(e){let t=this.buf[this.step(1)];if(t!=null)return E.of(t,e,this._reasons_by)}flush(){let{buf:e,step:t}=this;return this.step=this.buf=null,e.subarray(t.k|0)}}class M extends ${props(){let{buf:e,step:t}=this,[n,s,i]=y(e,t.k|0);if(t(n+s-i),n===0)return null;let o={},a=this.of(e.subarray(s,t.k|0));for(;a.has_more();){let u=w.get(a.u8()),c=a[u.type]();o[u.name]=u.op?a[u.op](o[u.name],c):c}return o}kv_obj(e=Object.create(null),[t,n]){return e[t]=n,e}u8_vec(e=[],t){return e.push(t),e}}function U(r,...e){r=class extends r{static reasons(t,...n){let s=this.prototype;s._reasons_by={...s._reasons_by};let i=s._reasons_by[t]||=new Map;for(let[o,a]of n)i.set(o,a);return this}};for(let t of e)t(r);return r}class j{static of(){return this.prototype.of()}of(){return{__proto__:this,$:[]}}static init(){return this}as_pkt(e){return this.pack([e])}push(...e){this.$.push(...e)}pack(e){let t,n,s=0,i=this.$;this.$=!1;for(t of i)s+=t.length;e=x(s,e),n=e.length;let o=new Uint8Array(n+s);o.set(e,0);for(t of i)o.set(t,n),n+=t.length;return o}u8(e){this.push([e&255])}u16(e){this.push([e>>>8&255,e&255])}u32(e){this.push([e>>>24&255,e>>>16&255,e>>>8&255,e&255])}vint(e){this.push(x(e))}bin(e){if(!e)return this.u16(0);if(typeof e=="string")return this.utf8(e);e.length!==e.byteLength&&(e=new Uint8Array(e)),this.u16(e.byteLength),this.push(e)}utf8(e){let t=new TextEncoder("utf-8").encode(e);this.u16(t.byteLength),this.push(t)}pair(e,t){this.utf8(e),this.utf8(t)}flags(e,t,n=0){return e!==void 0&&isNaN(+e)&&(e=t(e,0)),e|=n,this.push([e]),e}reason(e){this.push([e|0])}flush(e){e!=null&&this.push(typeof e=="string"?new TextEncoder("utf-8").encode(e):e),this.push=!1}}class N extends j{props(e){if(!e)return this.u8(0);if(Array.isArray(e)||(e=e.entries?Array.from(e.entries()):Object.entries(e)),e.length===0)return this.u8(0);let t=this.of();for(let[n,s]of e){let i=w.get(n);t[i.op||"one"](s,i)}this.push(t.pack())}one(e,t){this.u8(t.id),this[t.type](e)}kv_obj(e,t){for(let n of Object.entries(e))this.u8(t.id),this.pair(n)}u8_vec(e,t){for(let n of e)this.u8(t.id),this.u8(n)}}function P(r,e){class t extends Number{get session_present(){return this&!0}}return r[2]=(n,s)=>{let i=e.of(s);return n.flags=i.flags(t),n.reason=i.reason(n.type),5<=n.mqtt_level&&(n.props=i.props()),n}}function C(r){r.reasons("connack",[0,"Success"],[1,"Connection refused, unacceptable protocol version"],[2,"Connection refused, identifier rejected"],[3,"Connection refused, server unavailable"],[4,"Connection refused, bad user name or password"],[5,"Connection refused, not authorized"])}function I(r){C(r),r.reasons("connack",[129,"Malformed Packet"],[130,"Protocol Error"],[131,"Implementation specific error"],[132,"Unsupported Protocol Version"],[133,"Client Identifier not valid"],[134,"Bad User Name or Password"],[135,"Not authorized"],[136,"Server unavailable"],[137,"Server busy"],[138,"Banned"],[140,"Bad authentication method"],[144,"Topic Name invalid"],[149,"Packet too large"],[151,"Quota exceeded"],[153,"Payload format invalid"],[154,"Retain not supported"],[155,"QoS not supported"],[156,"Use another server"],[157,"Server moved"],[159,"Connection rate exceeded"])}function Q(r,e){return r[3]=(t,n)=>{let{hdr:s}=t;t.dup=!!(s&8),t.retain=!!(s&1);let i=t.qos=s>>1&3,o=e.of(n);return t.topic=o.utf8(),i!==0&&(t.pkt_id=o.u16()),5<=t.mqtt_level&&(t.props=o.props()),t.payload=o.flush(),t}}function O(r,e){return r[4]=(t,n)=>{let s=e.of(n);return t.pkt_id=s.u16(),5<=t.mqtt_level&&(t.reason=s.reason(t.type),t.props=s.props()),t}}function L(r){r.reasons("puback",[0,"Success"],[16,"No matching subscribers"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[144,"Topic Name invalid"],[145,"Packet identifier in use"],[151,"Quota exceeded"],[153,"Payload format invalid"])}function g(r){return(e,t)=>{let n=r.of(t);e.pkt_id=n.u16(),5<=e.mqtt_level&&(e.props=n.props());let s=e.answers=[];for(;n.has_more();)s.push(n.reason(e.type));return e}}function B(r,e){return r[9]=g(e)}function D(r){r.reasons("suback",[0,"Granted QoS 0"],[1,"Granted QoS 1"],[2,"Granted QoS 2"])}function G(r){D(r),r.reasons("suback",[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[143,"Topic Filter invalid"],[145,"Packet Identifier in use"],[151,"Quota exceeded"],[158,"Shared Subscriptions not supported"],[161,"Subscription Identifiers not supported"],[162,"Wildcard Subscriptions not supported"])}function R(r,e){return r[11]=g(e)}function F(r){r.reasons("unsuback",[0,"Success"],[17,"No subscription existed"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[143,"Topic Filter invalid"],[145,"Packet Identifier in use"])}function z(r){return r[12]=r[13]=e=>e}function W(r,e){return r[14]=(t,n)=>{if(n&&5<=t.mqtt_level){let s=e.of(n);t.reason=s.reason(t.type),t.props=s.props()}return t}}function J(r){r.reasons("disconnect",[0,"Normal disconnection"],[4,"Disconnect with Will Message"],[128,"Unspecified error"],[129,"Malformed Packet"],[130,"Protocol Error"],[131,"Implementation specific error"],[135,"Not authorized"],[137,"Server busy"],[139,"Server shutting down"],[141,"Keep Alive timeout"],[142,"Session taken over"],[143,"Topic Filter invalid"],[144,"Topic Name invalid"],[147,"Receive Maximum exceeded"],[148,"Topic Alias invalid"],[149,"Packet too large"],[150,"Message rate too high"],[151,"Quota exceeded"],[152,"Administrative action"],[153,"Payload format invalid"],[154,"Retain not supported"],[155,"QoS not supported"],[156,"Use another server"],[157,"Server moved"],[158,"Shared Subscriptions not supported"],[159,"Connection rate exceeded"],[160,"Maximum connect time"],[161,"Subscription Identifiers not supported"],[162,"Wildcard Subscriptions not supported"])}function H(r,e){return r[15]=(t,n)=>{if(5<=t.mqtt_level){let s=e.of(n);t.reason=s.reason(t.type),t.props=s.props()}return t}}function K(r){r.reasons("auth",[0,"Success"],[24,"Continue authentication"],[25,"Re-authenticate"])}function V(r,e){const t=new Uint8Array([0,4,77,81,84,84]),n=i=>0|(i.reserved?1:0)|(i.will_qos&3)<<3|(i.clean_start?2:0)|(i.will_flag?4:0)|(i.will_retain?32:0)|(i.password?64:0)|(i.username?128:0),s=i=>4|(i.qos&3)<<3|(i.retain?32:0);return r.connect=(i,o)=>{let a=e.of(o);a.push(t),a.u8(i);let{will:u,username:c,password:l}=o,f=a.flags(o.flags,n,0|(c?128:0)|(l?64:0)|(u?s(u):0));return a.u16(o.keep_alive),5<=i&&a.props(o.props),a.utf8(o.client_id),f&4&&(5<=i&&a.props(u.props),a.utf8(u.topic),a.bin(u.payload)),f&128&&a.utf8(c),f&64&&a.bin(l),a.as_pkt(16)}}function Y(r,e){return r.publish=(t,n)=>{let s=(n.qos&3)<<1,i=e.of(n);return i.utf8(n.topic),s!==0&&i.u16(n.pkt_id),5<=t&&i.props(n.props),i.flush(n.payload),i.as_pkt(48|s|(n.dup?8:0)|(n.retain?1:0))}}function X(r,e){return r.puback=(t,n)=>{let s=e.of(n);return s.u16(n.pkt_id),5<=t&&(s.reason(n.reason),s.props(n.props)),s.as_pkt(64)}}function Z(r,e){const t=n=>0|n.qos&3|(n.retain?4:0)|(n.retain_handling&3)<<2;return r.subscribe=(n,s)=>{let i=e.of(s);i.u16(s.pkt_id),5<=n&&i.props(s.props);let o=t(s);for(let a of s.topics)if(typeof a=="string")i.utf8(a),i.u8(o);else{let[u,c]=Array.isArray(a)?a:[a.topic,a.opts];i.utf8(u),c===void 0?i.u8(o):i.flags(c,t)}return i.as_pkt(130)}}function k(r,e){return r.unsubscribe=(t,n)=>{let s=e.of(n);s.u16(n.pkt_id),5<=t&&s.props(n.props);for(let i of n.topics)s.utf8(i);return s.as_pkt(162)}}function ee(r){r.pingreq=()=>new Uint8Array([192,0]),r.pingresp=()=>new Uint8Array([208,0])}function te(r,e){return r.disconnect=(t,n)=>{let s=e.of(n);return n&&5<=t&&(n.reason||n.props)&&(s.reason(n.reason),s.props(n.props)),s.as_pkt(224)}}function ne(r,e){return r.auth=(t,n)=>{if(5>t)throw new Error("Auth packets are only available after MQTT 5.x");let s=e.of(n);return s.reason(n.reason),s.props(n.props),s.as_pkt(240)}}const re=[P,Q,O,B,R,z,W,H],se=[V,X,Y,Z,k,ee,te,ne],ie=U(M,I,L,G,F,J,K),oe={decode_fns:re,mqtt_reader:ie,encode_fns:se,mqtt_writer:N};function ae(r,e=0){let t=e,n=(r[e]&127)<<0;return 128&r[e++]&&(n|=(r[e]&127)<<7,128&r[e++]&&(n|=(r[e]&127)<<14,128&r[e++]&&(n|=(r[e]&127)<<21))),[n,e,t]}function ue(r){let e=new Uint8Array(0);return t=>{e=e.byteLength===0?t:ce(e,t);let n=[];for(;;){let[s,i]=ae(e,1),o=s+i;if(e.byteLength<o)return n;let a=e[0],u=s===0?null:e.subarray(i,o);e=e.subarray(o);let c=r.decode_pkt(a,u,r);c!=null&&n.push(c)}}}function ce(r,e){let t=r.byteLength,n=new Uint8Array(t+e.byteLength);return n.set(r,0),n.set(e,t),n}const _e=["~","connect","connack","publish","puback","pubrec","pubrel","pubcomp","subscribe","suback","unsubscribe","unsuback","pingreq","pingresp","disconnect","auth"];function le(r,e,t){t={__proto__:t||e.pkt_ctx,mqtt_level:r,get hdr(){return this.b0&15},get id(){return this.b0>>>4},get type(){return _e[this.b0>>>4]}};let n,s=[],i={};for(n of e.encode_fns)n(i,e.mqtt_writer);for(n of e.decode_fns)n(s,e.mqtt_reader);return{pkt_ctx:t,encode_pkt(o,a){return i[o](r,a)},decode_pkt(o,a){return(s[o>>>4]||s[0])?.({__proto__:this.pkt_ctx,b0:o},a)},mqtt_stream(){let o={__proto__:this,pkt_ctx:{__proto__:t}};return o.pkt_ctx._base_=o.pkt_ctx,o.decode=ue(o),o}}}function fe(r=(...e)=>e){let e,t,n=(s,i)=>{e=s,t=i};return s=>(s=new Promise(n),r(s,e,t))}const d=fe();Promise.resolve({type:"init"});function de(r,[e,t]){let n=d(),s=d(),i=async(...u)=>(await s[0])(...u),o,a;return r._send=i,{async when_ready(){await s[0]},ping:he(()=>o?.("pingreq")),reset(u){o&&(u&&n[2](u),o=null,n=d(),r._send=i,r.conn_emit("on_disconnect",u===!1,u))},async send_connect(...u){o||await n[0];let c=await o(...u);return c[0].reason==0&&(a=!0,s[1](r._send=o),s=d(),r.conn_emit("on_ready")),c},is_set:()=>!!o,set(u,c){if(o)throw new Error("Already connected");u=u.mqtt_stream();let l={mqtt:r},f=h=>e(u.decode(h),l);return o=async(h,S,p)=>{let A=p!==void 0?t(p):!0;return await c(u.encode_pkt(h,S)),A},n[1](o),r.conn_emit("on_live",a),f}}}function he(r){let e;return t=>{if(e=clearInterval(e),t)return e=setInterval(r,1e3*t),e.unref?.(),!0}}function pe(r,e){if(r instanceof RegExp)return{keys:!1,pattern:r};var t,n,s,i,o=[],a="",u=r.split("/");for(u[0]||u.shift();s=u.shift();)t=s[0],t==="*"?(o.push("wild"),a+="/(.*)"):t===":"?(n=s.indexOf("?",1),i=s.indexOf(".",1),o.push(s.substring(1,~n?n:~i?i:s.length)),a+=~n&&!~i?"(?:/([^/]+?))?":"/([^/]+?)",~i&&(a+=(~n?"?":"")+"\\"+s.substring(i))):a+="/"+s;return{keys:o,pattern:new RegExp("^"+a+(e?"(?=$|/)":"/?$"),"i")}}function xe(r,e,t){t.done=!0}function me(){let r=[[],[]],e=Symbol(),t=n=>be(r,n);return{find:t,add(n,...s){let i=s.pop(),o=s.pop();if(typeof i!="function")if(i===!1)i=xe;else throw new TypeError;let a=pe(n.replace(/[+#]$/,"*"));return a.key=n,a.tgt=i,r[o?0:1].push(a),this},remove(n,s){let i=r[s?0:1];return m([i],n)},clear(n){r[n?0:1]=[],n==null&&(r[1]=[])},async invoke(n,s){s.idx=0,s.rm=e;for(let[a,u]of t(n.topic)){let c=await a(n,u,s);if(e===c&&m(r,a),s.done)break;s.idx++}let{pkt_id:i,qos:o}=n;o===1&&await s.mqtt._send("puback",{pkt_id:i})}}}function*be(r,e){for(let t of r)for(let n of t){let s=ye(e,n);s!==void 0&&(yield s)}}function ye(r,{keys:e,pattern:t,tgt:n}){let s=r[0]!=="/"?t.exec("/"+r):t.exec(r);if(s===null)return;if(e===!1){let{groups:o}=s;if(!o)return[n];let a={};for(let u in o)a[u]=o[u];return[n,a]}if(e.length===0)return[n];let i={};for(let o=0;o<e.length;o++)i[e[o]]=s[1+o];return[n,i]}function m(r,e){let t=n=>n===e||n.tgt===e||n.key===e;for(let n of r){let s=n.findIndex(t);if(0<=s)return!!n.splice(s,1)}return!1}const we={create(r){return{__proto__:this,target:r,hashbelt:[new Map]}},bind_pkt_future(r=100){let{hashbelt:e}=this,t,n=s=>e[0].set(t,s);return s=>(typeof s=="string"?t=s:(r=r+1&65535,t=s.pkt_id=r),new Promise(n))},answer(r,e){for(let t of this.hashbelt){let n=t.get(r);if(n!==void 0)return t.delete(r),n([e]),!0}return!1},rotate_belt(r){let{hashbelt:e}=this;e.unshift(new Map);for(let t of e.splice(r||5))for(let n of t.values())n([,"expired"])},cmdids:(()=>{return[()=>{},t,e,t,r,r,r,r,t,r,t,r,e,e,t,e];function r(n,s){n.answer(s.pkt_id,s)}function e(n,s,i){n.answer(s.type,s),t(n,s,i)}async function t({target:n},s,i){let o=n[`mqtt_${s.type}`]||n.mqtt_pkt;o!==void 0&&await o.call(n,s,i)}})()};function ge(r,e){let t=we.create(e),{cmdids:n}=t,{td:s=1e3,n:i=5}=r&&r.rotate||{},o=s+Date.now();return[a,t.bind_pkt_future()];function a(u,c){for(let l of u)n[l.id](t,l,c);Date.now()>o&&(t.rotate_belt(i),o=s+Date.now())}}class qe extends Error{constructor(e,t=e.reason){super(`[0x${t.toString(16)}] ${t.reason}`),this.mqtt_pkt=e,this.reason=t}}class q{constructor(e={}){this._conn_=de(this,this._init_dispatch(e,this))}async conn_emit(e,t,n){this.log_conn?.(e,t,n);try{let s=this[await e];s?await s.call(this,this,t,n):n&&await this.on_error(n,e)}catch(s){this.on_error(s,e)}}on_error(e,t){console.warn("[[u8-mqtt error: %s]]",t,e)}async connect(e={}){let t=e.client_id||["u8-mqtt--",""];Array.isArray(t)&&(e.client_id=t=this.init_client_id(t)),this.client_id=t,e.keep_alive==null&&(e.keep_alive=60);let n=await this._conn_.send_connect("connect",e,"connack");if(n[0].reason!=0)throw new this.MQTTError(n[0]);return this._conn_.ping(e.keep_alive),n}async disconnect(e={}){let t=await this._send("disconnect",e);return this._conn_.reset(!1),t}auth(e={}){return this._send("auth",e,"auth")}ping(){return this._send("pingreq",null,"pingresp")}subscribe(e,t){return e=b(e,t),this._send("subscribe",e,e)}_sub_chain(e,t){let n=this.subscribe([[e]],t),s=this.subs||(this.subs=new Map);return s.set(n.topic=e,s.last=n),this}unsubscribe(e,t){return e=b(e,t),this._send("unsubscribe",e,e)}get on_topic(){return this.router.add}subscribe_topic(e,...t){this.router.add(e,!0,t.pop());let n=this.topic_for(e);return this._sub_chain(n,t.pop())}unsubscribe_topic(e){this.router.remove(e,!0);let t=this.topic_for(e);return this.unsubscribe([[t]])}shared_subscribe(e,t,...n){this.router.add(t,!0,n.pop());let s=this.topic_for(t);return e!=null&&(s=`$share/${e}/${s}`),this._sub_chain(s,n.pop())}shared_unsubscribe(e,t){this.router.remove(t,!0);let n=this.topic_for(t);return e!=null&&(n=`$share/${e}/${n}`),this.unsubscribe([[n]])}topic_for(e){return e.replace(/[:*].*$/,"#")}publish(e,t){return _(this,e,t)}post(e,t,n){return _.m(this,e,t,n)}send(e,t,n){return _.mq(this,e,t,n)}store(e,t,n){return _.mqr(this,e,t,n)}json_post(e,t,n){return _.o(this,e,t,n)}json_send(e,t,n){return _.oq(this,e,t,n)}json_store(e,t,n){return _.oqr(this,e,t,n)}obj_post(e,t,n){return _.o(this,e,t,n)}obj_send(e,t,n){return _.oq(this,e,t,n)}obj_store(e,t,n){return _.oqr(this,e,t,n)}init_client_id(e){let t=this.client_id;return t===void 0&&(this.client_id=t=this.sess_client_id(e)),t}new_client_id(e){return[e[0],Math.random().toString(36).slice(2),e[1]].join("")}sess_client_id(e){let t=e.join(" "),n=sessionStorage.getItem(t);return n==null&&(n=this.new_client_id(e),sessionStorage.setItem(t,n)),n}_init_router(e){return this.router=me()}_init_dispatch(e){let t={__proto__:e.on_mqtt_type||{},router:this._init_router(e,this)};return t.mqtt_publish||=t.router.invoke,ge(this,t)}}{let r=q.prototype;Object.assign(r,{MQTTError:qe,pub:r.publish,sub:r.subscribe,unsub:r.unsubscribe,sub_topic:r.subscribe_topic,unsub_topic:r.unsubscribe_topic,shared_sub:r.shared_subscribe,shared_unsub:r.shared_unsubscribe})}function b(r,e){return typeof r=="string"?{topics:[r],...e}:r[Symbol.iterator]?{topics:[...r],...e}:e?{...r,...e}:r}async function _(r,e,t){if(e.payload===void 0){typeof t=="function"&&(t={fn_encode:t});let{msg:n}=e;switch(typeof n){case"function":t={...t,fn_encode:n};case"undefined":return i=>_(r,{...e,[e.arg||"payload"]:i},t);default:let{fn_encode:s}=t||{};e.payload=s?await s(n):JSON.stringify(n)}}return t&&(t.props&&(e.props=t.props),t.xform&&(e=t.xform(e)||e)),r._send("publish",e,e.qos?e:void 0)}Object.assign(_,{m:(r,e,t,n)=>_(r,{topic:e,payload:t,qos:0},n),mq:(r,e,t,n)=>_(r,{topic:e,payload:t,qos:1},n),mqr:(r,e,t,n)=>_(r,{topic:e,payload:t,qos:1,retain:1},n),o:(r,e,t,n)=>_(r,{topic:e,msg:t,arg:"msg",qos:0},n),oq:(r,e,t,n)=>_(r,{topic:e,msg:t,arg:"msg",qos:1},n),oqr:(r,e,t,n)=>_(r,{topic:e,msg:t,arg:"msg",qos:1,retain:1},n)});const ve={utf8(r){return new TextDecoder("utf-8").decode(r||this.payload)},json(r){return JSON.parse(this.utf8(r)||null)},text(r){return this.utf8(r)}};class Se extends q{constructor(e={}){super(e),this.with(e)}static mqtt_ctx(e,t,n=ve){let s=class extends this{};return s.prototype.mqtt_ctx=le(e,t,n),s}with(e){for(let[t,n]of Object.entries(e))typeof n=="function"&&(this[t]=n);return this}on_live(e,t){if(t)return e.connect()}_use_conn(e){return(this.reconnect=e)?.()}with_autoreconnect(e=2e3){return e.toFixed&&(e={delay:e}),this.with({on_reconnect(){this.delay(e.delay||2e3).then(this.reconnect).then(e.reconnect,e.error)}})}on_disconnect(e,t){if(!t)return e.on_reconnect?.()}delay(e){return new Promise(t=>setTimeout(t,e))}with_async_iter(e,t){let n=this._conn_.set(this.mqtt_ctx,t);return this._msg_loop=(async()=>{try{e=await e;for await(let s of e)n(s);this._conn_.reset()}catch(s){this._conn_.reset(s)}})(),this}with_stream(e,t){return t===void 0&&(t=e),this.with_async_iter(e,n=>t.write(n))}with_websock(e){if(!e?.send)return e=new URL(e||"ws://127.0.0.1:9001"),this._use_conn(()=>this.with_websock(new WebSocket(e,["mqtt"])));e.binaryType="arraybuffer";let t,{readyState:n}=e;if(n!==1){if(n!==0)throw new Error("Invalid WebSocket readyState");t=new Promise(o=>e.onopen=o)}let{_conn_:s}=this,i=s.set(this.mqtt_ctx,async o=>(await t,e.send(o)));return e.onmessage=o=>i(new Uint8Array(o.data)),e.onclose=o=>{if(!o.wasClean){var a=new Error("websocket connection close");a.code=o.code,a.reason=o.reason}s.reset(a)},this}}const Ae=Se.mqtt_ctx(4,oe),Te=r=>new Ae(r);async function Ee(){console.log("Connecting to MQTT host: wss://test.mosquitto.org:8081/mqtt");let r=Te().with_websock("wss://test.mosquitto.org:8081/mqtt").with_autoreconnect();return await r.connect(),r}function $e(r){return`${r}/commands`}function Me(r){const e=window.location;let t=`${e.origin}${e.pathname}#/handheld?id=${r}`;return console.log("Handheld URL: "+t),t}let Ue="toggle-background",je="enable-gravity";class v{_message;_timestamp;constructor(e){this._message=e,this._timestamp=new Date().toISOString()}get message(){return this._message}set message(e){this._message=e}get timestamp(){return this._timestamp}set timestamp(e){this._timestamp=e}static fromJson(e){const t=new v(e.message);return t._timestamp=e.timestamp,t}toJson(){return{message:this._message,timestamp:this._timestamp}}}export{v as M,je as T,$e as a,Me as b,Ue as c,Ee as g};
